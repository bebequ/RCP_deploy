package com.nebula.test;

import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;

import org.eclipse.draw2d.LightweightSystem;
import org.eclipse.e4.ui.di.Focus;
import org.eclipse.nebula.visualization.xygraph.dataprovider.CircularBufferDataProvider;
import org.eclipse.nebula.visualization.xygraph.figures.ToolbarArmedXYGraph;
import org.eclipse.nebula.visualization.xygraph.figures.Trace;
import org.eclipse.nebula.visualization.xygraph.figures.Trace.PointStyle;
import org.eclipse.nebula.visualization.xygraph.figures.Trace.TraceType;
import org.eclipse.nebula.visualization.xygraph.figures.XYGraph;
import org.eclipse.nebula.visualization.xygraph.util.XYGraphMediaFactory;
import org.eclipse.swt.SWT;
import org.eclipse.swt.graphics.Color;
import org.eclipse.swt.graphics.RGB;
import org.eclipse.swt.layout.FillLayout;
import org.eclipse.swt.layout.GridLayout;
import org.eclipse.swt.widgets.Canvas;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Text;
import org.eclipse.swt.layout.RowLayout;
import org.eclipse.swt.widgets.Group;
import org.eclipse.swt.widgets.Button;
import org.eclipse.draw2d.XYLayout;
import org.eclipse.swt.layout.RowData;
import org.eclipse.swt.layout.GridData;
import org.eclipse.swt.events.SelectionAdapter;
import org.eclipse.swt.events.SelectionEvent;
import org.eclipse.swt.widgets.Combo;
import org.eclipse.swt.widgets.Label;

public class DemoMain {

	public DemoMain() {
	}

	/**
	 * Create contents of the view part.
	 */
	private double mTarget = 2.1;
	private double[][] mBufferLow = new double[3][];
	private double[][] mBufferHigh = new double[3][];	
	private double[] mIndex = new double[256];
	private String[] mP0Mark = {"R0", "G0", "B0"};
	private String[] mP1Mark = {"R1", "G1", "B1"};
	private RGB[] mXYColorLow = {XYGraphMediaFactory.COLOR_RED, XYGraphMediaFactory.COLOR_GREEN, XYGraphMediaFactory.COLOR_BLUE};
	private RGB[] mXYColorHigh = {XYGraphMediaFactory.COLOR_PINK, XYGraphMediaFactory.COLOR_YELLOW, XYGraphMediaFactory.COLOR_CYAN};
	private Trace[] mTraceHigh = new Trace[3];
	private Trace[] mTraceLow = new  Trace[3];
	private CircularBufferDataProvider[] mTraceDataProviderLow = new CircularBufferDataProvider[3];
	private CircularBufferDataProvider[] mTraceDataProviderHigh = new CircularBufferDataProvider[3];
	
	@PostConstruct
	public void createControls(Composite parent) {
		for(int i=0; i<mBufferLow.length; i++)
		{
			mBufferLow[i] = new double[256];
			for(int j=0; j<mBufferLow[i].length; j++)
			{
				mBufferLow[i][j] = 0;//Math.pow(j/255.0, mTarget+i*0.5+0.5);
			}
		}
		for(int i=0; i<mBufferLow.length; i++)
		{
			mBufferHigh[i] = new double[256];
			for(int j=0; j<mBufferHigh[i].length; j++)
			{
				mBufferHigh[i][j] = 0;//Math.pow(j/255.0, mTarget+i*0.3);
			}
		}
		for(int i=0; i<mIndex.length; i++)
		{
			mIndex[i] = i;
		}
		parent.setLayout(new GridLayout(1, false));
		 
        XYGraph xyGraph = new XYGraph();
		final Canvas canvas = new Canvas(parent, SWT.NONE);
		canvas.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true, 1, 1));
        final LightweightSystem lws = new LightweightSystem(canvas);
        
        Group group = new Group(parent, SWT.NONE);
        GridLayout gl_group = new GridLayout(2, false);
        gl_group.verticalSpacing = 0;
        gl_group.horizontalSpacing = 0;
        gl_group.marginHeight = 0;
        gl_group.marginWidth = 0;
        group.setLayout(gl_group);
        group.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, false, 1, 1));
        
        Composite composite_1 = new Composite(group, SWT.NONE);
        composite_1.setLayout(new GridLayout(4, false));
        composite_1.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, false, 1, 1));
        
        Combo combo = new Combo(composite_1, SWT.NONE);
        combo.setLayoutData(new GridData(SWT.LEFT, SWT.CENTER, true, false, 1, 1));

        combo.setItems(new String[] {"Both", "Low", "High"});
        combo.select(0);
        
        Button btnCheckButton = new Button(composite_1, SWT.CHECK);
        btnCheckButton.setLayoutData(new GridData(SWT.LEFT, SWT.CENTER, true, false, 1, 1));
        btnCheckButton.setSelection(true);
        
        btnCheckButton.addSelectionListener(new SelectionAdapter() {
        	@Override
        	public void widgetSelected(SelectionEvent e) {
        		if(btnCheckButton.getSelection()) {
        			mTraceLow[0].setVisible(true);
        			mTraceHigh[0].setVisible(true);
            		
        		} else { 
        			mTraceLow[0].setVisible(false);
        			mTraceHigh[0].setVisible(false);
        		}
        	}
        });
        btnCheckButton.setText("R");
        
          Button btnCheckButton_1 = new Button(composite_1, SWT.CHECK);
          btnCheckButton_1.setLayoutData(new GridData(SWT.LEFT, SWT.CENTER, true, false, 1, 1));
          btnCheckButton_1.setSelection(true);
          
          btnCheckButton_1.addSelectionListener(new SelectionAdapter() {
          	@Override
          	public void widgetSelected(SelectionEvent e) {
          		if(btnCheckButton_1.getSelection()) {
          			mTraceLow[1].setVisible(true);
          			mTraceHigh[1].setVisible(true);
              		
          		} else { 
          			mTraceLow[1].setVisible(false);
          			mTraceHigh[1].setVisible(false);
          		}
          	}
          });  
          btnCheckButton_1.setText("G");
          
             Button btnCheckButton_2 = new Button(composite_1, SWT.CHECK);
             btnCheckButton_2.setLayoutData(new GridData(SWT.LEFT, SWT.CENTER, true, false, 1, 1));
             btnCheckButton_2.setSelection(true);
             btnCheckButton_2.addSelectionListener(new SelectionAdapter() {
             	@Override
             	public void widgetSelected(SelectionEvent e) {
             		if(btnCheckButton_2.getSelection()) {
             			mTraceLow[2].setVisible(true);
             			mTraceHigh[2].setVisible(true);
                 		
             		} else { 
             			mTraceLow[2].setVisible(false);
             			mTraceHigh[2].setVisible(false);
             		}
             	}
             });
             btnCheckButton_2.setText("B");
        
        combo.addSelectionListener(new SelectionAdapter() {
        	@Override
        	public void widgetSelected(SelectionEvent e) {
        		switch(combo.getSelectionIndex())
        		{
        		case 0:
	        		{
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(!mTraceLow[i].isEnabled()) {
	        					mTraceLow[i].setEnabled(true);
	        					xyGraph.addTrace(mTraceLow[i]);
	        				}
	        			}
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(!mTraceHigh[i].isEnabled()) {
	        					mTraceHigh[i].setEnabled(true);
	        					xyGraph.addTrace(mTraceHigh[i]);
	        				}
	        			}
	        		}
        			break;
        		case 1:
	        		{
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(!mTraceLow[i].isEnabled()) {
	        					mTraceLow[i].setEnabled(true);
	        					xyGraph.addTrace(mTraceLow[i]);
	        				}
	        			}
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(mTraceHigh[i].isEnabled()) {
		        			  xyGraph.removeTrace(mTraceHigh[i]);
		        			  mTraceHigh[i].setEnabled(false);	  
	        				}
	        			}
	        		}
        			break;
        		case 2:
	        		{
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(mTraceLow[i].isEnabled()) {
	        					xyGraph.removeTrace(mTraceLow[i]);
	        					mTraceLow[i].setEnabled(false);
	        				}
	        			}
	        			for(int i=0; i<mBufferHigh.length; i++) {
	        				if(!mTraceHigh[i].isEnabled()) {
	        					mTraceHigh[i].setEnabled(true);	
	        					xyGraph.addTrace(mTraceHigh[i]);
	        				}
	        			}
	        		}
        			break;
        		default:
        			break;
        		}
        		
        	}
        });
  

        xyGraph.setTitle("Correct Gamma Curve");
        lws.setContents(xyGraph);
        //ToolbarArmedXYGraph toolbarArmedXYGraph = new ToolbarArmedXYGraph(xyGraph);
        //lws.setContents(toolbarArmedXYGraph);
 
        xyGraph.getPrimaryXAxis().setShowMajorGrid(true);
        xyGraph.getPrimaryYAxis().setShowMajorGrid(true);
        xyGraph.getPrimaryXAxis().setRange(0, 255);
        xyGraph.getPrimaryYAxis().setRange(0, 1);
        xyGraph.getPrimaryXAxis().setTitle("index");
        xyGraph.getPrimaryYAxis().setTitle("mag");
        
        for(int i=0; i<mBufferLow.length; i++)
        {
        	
        	mTraceDataProviderLow[i] = new CircularBufferDataProvider(false);
        	mTraceDataProviderLow[i].setBufferSize(256);
        	mTraceDataProviderLow[i].setCurrentXDataArray(mIndex);
        	mTraceDataProviderLow[i].setCurrentYDataArray(mBufferLow[i]);
        	mTraceLow[i] = new Trace(mP0Mark[i], xyGraph.getPrimaryXAxis(), xyGraph.getPrimaryYAxis(), mTraceDataProviderLow[i]);
        	mTraceLow[i].setPointStyle(PointStyle.NONE);
        	mTraceLow[i].setTraceColor(XYGraphMediaFactory.getInstance().getColor(mXYColorLow[i]));
            xyGraph.addTrace(mTraceLow[i]);
        }
        for(int i=0; i<mBufferHigh.length; i++)
        {
        	mTraceDataProviderHigh[i] = new CircularBufferDataProvider(false);
        	mTraceDataProviderHigh[i].setBufferSize(256);
        	mTraceDataProviderHigh[i].setCurrentXDataArray(mIndex);
        	mTraceDataProviderHigh[i].setCurrentYDataArray(mBufferHigh[i]);
            mTraceHigh[i] = new Trace(mP1Mark[i], xyGraph.getPrimaryXAxis(), xyGraph.getPrimaryYAxis(), mTraceDataProviderHigh[i]);
            mTraceHigh[i].setPointStyle(PointStyle.NONE);
            mTraceHigh[i].setTraceColor(XYGraphMediaFactory.getInstance().getColor(mXYColorHigh[i]));
            xyGraph.addTrace(mTraceHigh[i]);
        }
        
        Composite composite = new Composite(group, SWT.NONE);
        composite.setLayoutData(new GridData(SWT.CENTER, SWT.CENTER, false, false, 1, 1));
        GridLayout gl_composite = new GridLayout(1, false);
        gl_composite.horizontalSpacing = 0;
        gl_composite.verticalSpacing = 0;
        gl_composite.marginHeight = 0;
        gl_composite.marginWidth = 0;
        composite.setLayout(gl_composite);
        
        Combo combo_1 = new Combo(composite, SWT.NONE);
        combo_1.setLayoutData(new GridData(SWT.CENTER, SWT.CENTER, false, false, 1, 1));
        
        Button btnNewButton = new Button(composite, SWT.NONE);
        btnNewButton.setLayoutData(new GridData(SWT.CENTER, SWT.CENTER, false, false, 1, 1));
        btnNewButton.addSelectionListener(new SelectionAdapter() {
        	@Override
        	public void widgetSelected(SelectionEvent e) {
        		for(int i=0; i<mBufferLow.length; i++){
        			double newTarget = mTarget + Math.random()*(Math.random()>0.5?1:-1);
        			for(int j=0; j<mBufferLow[i].length; j++)
	    			{
	    				mBufferLow[i][j] = Math.pow(j/255.0,newTarget);
	    			}
	        		mTraceDataProviderLow[i].triggerUpdate();
        		}
        		for(int i=0; i<mBufferHigh.length; i++){
        			double newTarget = mTarget + Math.random()*(Math.random()>0.5?1:-1);
	        		for(int j=0; j<mBufferHigh[i].length; j++)
	    			{
	    				mBufferHigh[i][j] = Math.pow(j/255.0, newTarget);
	    			}
	        		mTraceDataProviderHigh[i].triggerUpdate();
        		}
        	}
        });
        btnNewButton.setText("Generate");
	}

	@PreDestroy
	public void dispose() {
	}

	@Focus
	public void setFocus() {
		// TODO	Set the focus to control
	}
}
